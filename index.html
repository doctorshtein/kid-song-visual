<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kid-Friendly Music Notation Generator</title>
  <style>
    :root{
      --bg:#0b0b10; --panel:#12121a; --ink:#e6e6ef; --muted:#a6a6b5; --accent:#6ea8fe;
      --border:#232334; --good:#2ecc71; --warn:#f1c40f; --danger:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:linear-gradient(180deg,#0a0a12 0%,#0f0f18 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
                   Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header{padding:18px 20px; border-bottom:1px solid var(--border); position:sticky; top:0; backdrop-filter:saturate(140%) blur(6px); background:rgba(10,10,18,0.6);}
    header h1{margin:0; font-size:20px; letter-spacing:.2px}
    main{display:grid; grid-template-columns: 380px 1fr; gap:20px; padding:20px; align-items:start}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .left{padding:16px}
    .left h2{margin:0 0 8px 0; font-size:16px}
    textarea{width:100%; min-height:180px; background:#0e0e16; color:var(--ink); border:1px solid var(--border); border-radius:12px; padding:12px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .row{display:grid; grid-template-columns: 1fr 110px; gap:10px; align-items:center}
    .controls{display:grid; gap:10px; margin-top:12px}
    .controls label{display:flex; align-items:center; justify-content:space-between; gap:12px; font-size:13px; color:var(--muted)}
    .controls input[type="number"], .controls input[type="text"], .controls select {
      width:110px; padding:6px 8px; border:1px solid var(--border); border-radius:10px; background:#0e0e16; color:var(--ink);
    }
    .controls input[type="range"]{width:100%}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      background:linear-gradient(180deg,#1a84ff,#1463cc);
      color:white; border:0; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 20px rgba(30,100,210,.35);
    }
    button.secondary{background:#202033; box-shadow:none; border:1px solid var(--border)}
    button:disabled{opacity:.6; cursor:not-allowed}
    .preview{padding:12px; overflow:auto; max-height:78vh}
    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}
    .dot{width:14px; height:14px; border-radius:50%}

    @media print {
      header, .left { display:none !important; }
      main{grid-template-columns: 1fr; padding:0}
      .preview{max-height:none; overflow:visible}
      body{background:white}
      .card{border:none; box-shadow:none}
    }
  </style>
  <!-- add a dependency to a script https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.2.4/svg.min.js-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.2.4/svg.min.js"></script>
</head>
<body>
  <header>
    <h1>ðŸŽµ Kid-Friendly Music Notation Generator</h1>
  </header>
  <main>
    <section class="left card">
      <h2>Song input</h2>
      <label style="display:block; margin-bottom:8px; font-size:13px; color:var(--muted)">
        Song name
        <input type="text" id="songName" style="width:100%; margin-top:4px; padding:8px; border-radius:8px; border:1px solid var(--border); background:#0e0e16; color:var(--ink);" placeholder="Enter song name..." />
      </label>
      <p style="color:var(--muted); font-size:13px; margin:6px 0 10px">Each line â†’ one staff row. Separate groups with spaces (adds vertical bars). Notes: <strong>aâ€“g</strong>, optional octave like <strong>a+1</strong> or <strong>e-1</strong>. Use <strong>_</strong> for a rest. Example shown below.</p>
      <textarea id="input"></textarea>
      <div class="controls">
        <h2 style="margin-top:10px">Layout & Style</h2>
        <label>Note spacing (px)
          <input type="number" id="noteSpacing" value="64" min="28" max="160" step="2" />
        </label>
        <label>Note radius (px)
          <input type="number" id="noteRadius" value="10" min="8" max="36" />
        </label>
        <label>Note bar height (px)
          <input type="number" id="noteBarHeight" value="45" min="10" max="80" />
        </label>
        <label>Background circle radius Ã—
          <input type="number" id="bgRadius" value="22" min="8" max="64" />
        </label>
        <label>Note header radius (px)
          <input type="number" id="noteHeaderRadius" value="14" min="8" max="36" />
        </label>
        <label>Row height (px)
          <input type="number" id="rowH" value="20" min="10" max="100" />
        </label>
        <label>Staff left offset (px)
          <input type="number" id="staffLeftOffset" value="10" min="0" max="100" />
        </label>
        <label>Staff divider width (px)
          <input type="number" id="staffDividerWidth" value="20" min="0" max="100" />
        </label>
        <label>Staff header offset (px)
          <input type="number" id="staffHeaderOffset" value="10" min="0" max="100" />
        </label>
        <label>Line spacing (px)
          <input type="number" id="lineSpacing" value="20" min="0" max="100" />
        </label>
        <label>Song name font size (px)
          <input type="number" id="songNameFontSize" value="24" min="10" max="100" />
        </label>
        <label>Font
          <select id="fontSel">
            <option value="system-ui,Segoe UI,Roboto,Arial">System UI</option>
            <option value="'Gill Sans', 'Trebuchet MS', system-ui">Humanist</option>
            <option value="'Comic Sans MS', 'Comic Sans', system-ui">Comic Sans (fun)</option>
            <option value="'Times New Roman', Times, serif">Times</option>
            <option value="'Courier New', Courier, monospace">Monospace</option>
          </select>
        </label>
        <label title="Adds a tiny superscript Â± for octave offsets like a+1 or e-1"><span>Show octave marks (Â±)</span>
          <input type="checkbox" id="showOctaves" />
        </label>
        <div class="row">
          <label style="grid-column:1/-1">Export scale (for PNG)</label>
          <input type="range" id="exportScale" min="1" max="4" step="1" value="2" />
        </div>
        <div class="btns">
          <button id="renderBtn">Render</button>
          <button id="pngBtn" class="secondary">Export PNG</button>
          <button id="svgBtn" class="secondary">Export SVG</button>
        </div>
      </div>

      <div class="legend" id="legend"></div>

      <details style="margin-top:12px; color:var(--muted)">
        <summary>Input cheatsheet</summary>
        <ul>
          <li><code>c d e f g a b</code> â†’ notes (case-insensitive)</li>
          <li><code>_</code> â†’ rest</li>
          <li><code>a+1</code>, <code>e-1</code> â†’ octave offsets (optional)</li>
          <li><code>|</code> split groups â†’ vertical bar between groups</li>
        </ul>
      </details>
    </section>

    <section class="card preview">
      <div id="previewBox"></div>
    </section>
  </main>

  <script>
    // Color palette (roughly Boomwhacker-inspired, tuned for contrast)
    const NOTE_COLORS = {
      c: '#e74c3c', // red
      d: '#e67e22', // orange
      e: '#f1c40f', // yellow
      f: '#2ecc71', // green
      g: '#3498db', // blue
      a: '#9b59b6', // purple
      b: '#e91e63'  // pink/magenta
    };

    const NOTE_POSITIONS = {
      '0': {
        'a': 7,
        'b': 6.5,
        'c': 6,
        'd': 5.5,
        'e': 5,
        'f': 4.5,
        'g': 4,
      },
      '1': {
        'a': 3.5,
        'b': 3,
        'c': 2.5,
        'd': 2,
        'e': 1.5,
        'f': 1,
        'g': 0.5
      },
      '-1': {
        'a': 10.5,
        'b': 10,
        'c': 9.5,
        'd': 9,
        'e': 8.5,
        'f': 8,
        'g': 7.5
      }
    };

    const NOTE_NUMBERS = {
      '-1': { a: '-9', b: '-8', c: '-7', d: '-6', e: '-5', f: '-4', g: '-3'}, // octave -1
      '0':  { a: '-2', b: '-1', c: '1', d: '2', e: '3', f: '4', g: '5'}, // octave 0 = middle
      '1':  { a: '6', b: '7', c: '8', d: '9', e: '10', f: '11', g: '12'}, // octave +1
    }

    function getNoteColor(note){
      if(note.type !== 'note') return '#888';
      return NOTE_COLORS[note.letter] || '#bbb';
    }

    function getNotePosition(note){
      if(note.type !== 'note') return null;
      const oct = note.octave ? (note.octave > 1 ? '1' : (note.octave < -1 ? '-1' : String(note.octave))) : '0';
      return NOTE_POSITIONS[oct][note.letter] || null;
    }

    function getNoteHeaderText(note){
      if(note.type !== 'note') return '';
      const oct = note.octave ? (note.octave > 1 ? '1' : (note.octave < -1 ? '-1' : String(note.octave))) : '0';
      return (NOTE_NUMBERS[oct][note.letter] || '');
    }

    function getNoteDisplayText(note, showOctaves){
      if(note.type !== 'note') return '';
      const oct = note.octave ? (note.octave > 1 ? '1' : (note.octave < -1 ? '-1' : String(note.octave))) : '0';
      return note.letter.toUpperCase() + (showOctaves && note.octave !== 0 ? (note.octave > 0 ? '+' : '') + note.octave : '');
    }

    const els = {
      input: document.getElementById('input'),
      spacing: document.getElementById('noteSpacing'),
      radius: document.getElementById('noteRadius'),
      barHeight: document.getElementById('noteBarHeight'),
      bgRadius: document.getElementById('bgRadius'),
      noteHeaderRadius: document.getElementById('noteHeaderRadius'),
      rowH: document.getElementById('rowH'),
      staffLeftOffset: document.getElementById('staffLeftOffset'),
      staffDividerWidth: document.getElementById('staffDividerWidth'),
      staffHeaderOffset: document.getElementById('staffHeaderOffset'),
      fontSel: document.getElementById('fontSel'),
      showOctaves: document.getElementById('showOctaves'),
      renderBtn: document.getElementById('renderBtn'),
      pngBtn: document.getElementById('pngBtn'),
      svgBtn: document.getElementById('svgBtn'),
      exportScale: document.getElementById('exportScale'),
      preview: document.getElementById('previewBox'),
      legend: document.getElementById('legend'),
      songName: document.getElementById('songName'),
      lineSpacing: document.getElementById('lineSpacing'),
      songNameFontSize: document.getElementById('songNameFontSize')
    };

    function getRenderingConfig()
    {
      return {
        note: {
          radius: parseFloat(els.radius.value),
          highlightRadius: parseFloat(els.bgRadius.value),
          barHeight: parseFloat(els.barHeight.value),
          font: els.fontSel.value,
          showOctaves: els.showOctaves.checked
        },
        noteHeader: {
          radius: parseFloat(els.noteHeaderRadius.value),
        },
        staff: {
          leftOffset: parseFloat(els.staffLeftOffset.value),
          dividerWidth: parseFloat(els.staffDividerWidth.value),
          noteSpacing: parseFloat(els.spacing.value),
          rowHeight: parseFloat(els.rowH.value),
          headerOffset: parseFloat(els.staffHeaderOffset.value)
        },
        song: {
          lineSpacing: parseFloat(els.lineSpacing.value),
          songNameFontSize: parseFloat(els.songNameFontSize.value),
        }
      };
    }

    function setExample(){
      els.songName.value = 'Twinkle Twinkle Little Star';
      els.input.value = `cc|gg|a+1a+1|g_\nff|ee|dd|c_`;
    }

    function buildLegend(){
      els.legend.innerHTML = '';
      Object.entries(NOTE_COLORS).forEach(([k,v])=>{
        const chip = document.createElement('div'); chip.className='chip';
        const dot = document.createElement('span'); dot.className='dot'; dot.style.background=v;
        chip.appendChild(dot); chip.appendChild(document.createTextNode(' ' + k.toUpperCase()));
        els.legend.appendChild(chip);
      });
    }

    function parseInput(text){
      // Returns array of lines; each line is array of groups; each group is array of events {type:'note'|'rest', letter?, octave?}
      const lines = [];
      const rawLines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length>0);
      const tokenRe = /([a-gA-G](?:[+-]\d+)?|_)/g;
      for(const raw of rawLines){
        const groups = raw.split('|');
        const outGroups = [];
        for(const group of groups){
          const events = [];
          let m;
          while((m = tokenRe.exec(group)) !== null){
            const tok = m[1];
            if(tok === '_'){ events.push({type:'rest'}); continue; }
            const letter = tok[0].toLowerCase();
            const octm = /([+-]\d+)$/.exec(tok);
            const octave = octm ? parseInt(octm[1],10) : 0; // relative to middle (0)
            events.push({type:'note', letter, octave});
          }
          if(events.length) outGroups.push(events);
        }
        if(outGroups.length) lines.push(outGroups);
      }
      return lines;
    }

    function renderNote(svg, cx, cy, config, note) {
      if (note.type !== 'note') {
        return;
      }
      const radius = config.note.radius;
      const highlightRadius = config.note.highlightRadius;
      const color = getNoteColor(note);
      const letter = getNoteDisplayText(note, config.note.showOctaves);

      // Background circle (color-coded)
      svg.circle(highlightRadius*2).center(cx, cy).fill(color).opacity(0.9);

      // Foreground circle
      svg.circle(radius*2).center(cx, cy).fill('white').stroke({color:'#000', width:2});
      
      // Letter
      // letterEl.setAttribute('text-anchor','middle');
      svg.text(letter.toUpperCase()).font({
        family: 'system-ui,Segoe UI,Roboto,Arial',
        size: radius*1.2,
        fill: '#000'
      }).center(cx, cy-radius*0.11).attr('alignment-baseline', 'middle');

      // Note bar
      svg.line(cx+radius, cy-config.note.barHeight, cx+radius, cy).stroke({color:'#000', width:2});
    }

    function renderNoteHead(svg, cx, cy, config, note) {
      if (note.type !== 'note') {
        return;
      }
      const color = getNoteColor(note);
      const letter = getNoteHeaderText(note);
      const radius = config.noteHeader.radius;
      // Background circle (color-coded)
      svg.circle(radius*2).center(cx, cy).fill(color).opacity(0.9);

      // Letter
      svg.text(letter.toUpperCase()).font({
        family: 'system-ui,Segoe UI,Roboto,Arial',
        size: radius*1.4,
        fill: 'white'
      }).center(cx, cy-radius*0.12);
      //.attr('text-anchor','middle')
      //.attr('alignment-baseline', 'middle');
    }

    function renderStaff(svg, x, y, config, groupSize, groupCount) {
      const leftOffset = config.staff.leftOffset;
      const spacing = config.staff.rowHeight;
      const groupSpacing = config.staff.noteSpacing * groupSize;
      const width = leftOffset + groupCount*groupSpacing + config.staff.dividerWidth*groupCount;

      for (let lineNum=1; lineNum < 6; lineNum++) {
        svg
          .line(x, y + lineNum*spacing, x+width, y + lineNum*spacing)
          .stroke({color:'#000', width:2});
      }
      svg
        .line(x+leftOffset, y, x+leftOffset, y + 6*spacing)
        .stroke({color:'#000', width:2});
      
      for (let g=0; g<groupCount; g++) {
        const gx = x + leftOffset + (g+1)*groupSpacing + g*config.staff.dividerWidth + config.staff.dividerWidth/2;
        svg
          .line(gx, y+0.5*spacing, gx, y + 5.5*spacing)
          .stroke({color:'#000', width:2, dasharray:'4,4'});
      }
    }

    function renderRow(svg, x, y, config, noteGroups) {
      const headerOffset = config.staff.headerOffset;
      const leftOffset = config.staff.leftOffset;
      const noteSpacing = config.staff.noteSpacing;

      renderStaff(svg, x, y+headerOffset, config, noteGroups[0].length, noteGroups.length);

      for (let g=0; g<noteGroups.length; g++) {
        const group = noteGroups[g];
        const groupWidth = noteSpacing*group.length;
        for (let n=0; n<group.length; n++) {
          const note = group[n];
          if (note.type !== 'note') continue;
          const cx = x + leftOffset + g*groupWidth + g*config.staff.dividerWidth + n*noteSpacing + noteSpacing/2;
          const headCy = y + headerOffset/2;
          renderNoteHead(svg, cx, headCy, config, note);
          const notePos = getNotePosition(note);
          const noteCy = y + headerOffset + notePos*config.staff.rowHeight;
          renderNote(svg, cx, noteCy, config, note, );
        }
      }
    }

    function estimateWidth(config, noteGroups){
      const leftOffset = config.staff.leftOffset;
      const noteSpacing = config.staff.noteSpacing;
      const groupCount = noteGroups.length;
      const groupSize = noteGroups.reduce((max, g)=>Math.max(max, g.length), 0);
      return leftOffset + groupCount*groupSize*noteSpacing + config.staff.dividerWidth*groupCount;
    }

    function renderSVG(){
      const lines = parseInput(els.input.value);
      if(!lines.length){
        els.preview.innerHTML = '<p style="color:#98a; padding:20px">Enter some notes to renderâ€¦</p>';
        return null;
      }

      const config = getRenderingConfig();

      //const note = renderNoteHead(16, NOTE_COLORS.c, '1');
      //els.preview.innerHTML = '';
      //els.preview.appendChild(note);
      const parent = SVG()
        //.addTo(els.preview)
        //.viewbox(0,0,800,800)
        .css({'background':'white'});

      let currentY = 0;

      if (els.songName.value.trim()) {
        const width = estimateWidth(config, lines[0]);
        parent.text(els.songName.value.trim())
        .font({
          family: config.note.font,
          size: config.song.songNameFontSize,
          fill: '#FFF',
          weight: 'bold'
        }).cx(width/2).y(0)
        .stroke({ color: '#000', width: 1, linecap: 'round', linejoin: 'round' });
        currentY = config.song.lineSpacing + parent.bbox().height;
      }

      for (let i=0; i<lines.length; i++) {
        const line = lines[i];
        renderRow(parent, 0, currentY, config, line);
        currentY = config.song.lineSpacing + parent.bbox().height;
      }
      const sz = parent.bbox();
      parent.viewbox(-10,-10,sz.width+10, sz.height+10);
      els.preview.innerHTML = '';
      parent.addTo(els.preview);
      return parent;
    }

    function svgToBlob(svg){
      const s = new XMLSerializer().serializeToString(svg);
      return new Blob([s], {type:'image/svg+xml;charset=utf-8'});
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    async function exportPNG(){
      const svg = renderSVG(); if(!svg) return;
      const scale = parseInt(els.exportScale.value, 10) || 2;
      const blob = svgToBlob(svg);
      const url = URL.createObjectURL(blob);
      const img = new Image();
      await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth * scale; canvas.height = img.naturalHeight * scale;
      const ctx = canvas.getContext('2d');
      ctx.setTransform(scale,0,0,scale,0,0);
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(b=>{ if(!b) return; downloadBlob(b, 'notation.png'); URL.revokeObjectURL(url); }, 'image/png');
    }

    function exportSVG(){
      const svg = renderSVG(); if(!svg) return;
      downloadBlob(svgToBlob(svg), 'notation.svg');
    }

    function printOut(){
      const svg = renderSVG(); if(!svg) return;
      const w = window.open('', '_blank');
      const s = new XMLSerializer().serializeToString(svg);
      w.document.write(`<!DOCTYPE html><html><head><title>Print Notation</title>
        <style>@page{size:auto; margin:10mm} body{margin:0} .wrap{display:flex; justify-content:center; padding:10mm}</style>
      </head><body><div class="wrap">${s}</div></body></html>`);
      w.document.close();
      w.focus(); w.print();
    }

    // Hook up UI
    els.renderBtn.addEventListener('click', renderSVG);
    els.pngBtn.addEventListener('click', exportPNG);
    els.svgBtn.addEventListener('click', exportSVG);
    [els.spacing, els.radius, els.bgRadius, els.rowH, els.fontSel, els.showOctaves].forEach(el=>{
      el.addEventListener('input', renderSVG);
    });
    // Add listeners for new controls
    [els.barHeight, els.noteHeaderRadius, els.staffLeftOffset, els.staffDividerWidth, els.staffHeaderOffset, els.songName, els.lineSpacing, els.songNameFontSize].forEach(el=>{
      el.addEventListener('input', renderSVG);
    });

    // Init
    setExample();
    buildLegend();
    renderSVG();
  </script>
</body>
</html>